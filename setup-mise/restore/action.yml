---
name: "restore/setup mise"

inputs:
  mise_envs:
    description: |
      A comma-separated list of environments.

      Mise looks for environment-targeted files named like mise.{ENV}.toml
      alongside the base mise.toml, and merges them with a defined precedence.

      Multiple environments can be specified in order, such as
      `mise_envs: "ci,test"`, with the last in the list taking precedence
      during merge.
    default: ""
    required: false
  mise_version:
    default: ""
  working_directory:
    description: "The directory with the root of the project"
    default: "."
    required: false
  cache_s3_endpoint:
    type: "string"
    required: true
  cache_s3_access_key:
    type: "string"
    required: true
  cache_s3_secret_key:
    type: "string"
    required: true
  cache_s3_bucket_name:
    type: "string"
    required: true

outputs:
  data_dir:
    description: "The path to mise's data directory"
    value: "${{ steps.mise-cache-dirs.outputs.data_dir }}"

runs:
  using: "composite"
  steps:
    - name: "Retrieve mise directories to cache"
      uses: "bckground/actions/setup-mise/internal@main"
      id: "mise-cache-dirs"

    - name: "Restore mise caches"
      uses: "bckground/actions-cache/restore@8a7e86207dc72a3f6bd8cbc23f4f061558fee8f8"
      with:
        endpoint: "${{ inputs.cache_s3_endpoint }}"
        accessKey: "${{ inputs.cache_s3_access_key }}"
        secretKey: "${{ inputs.cache_s3_secret_key }}"
        bucket: "${{ inputs.cache_s3_bucket_name }}"
        use-fallback: false
        key: "mise-on-${{ runner.os }}-${{ runner.arch }}-"
        restore-keys: |
          mise-on-${{ runner.os }}-${{ runner.arch }}-
        path: |
          ${{ steps.mise-cache-dirs.outputs.data_dir }}

    - name: "Set up mise"
      uses: "jdx/mise-action@5ac50f778e26fac95da98d50503682459e86d566" # v3.2.0
      env:
        MISE_ENV: "${{ inputs.mise_envs }}"
      with:
        version: "${{ inputs.mise_version }}"
        install: true # Run `mise install`.
        cache: false
        experimental: true # Enable experimental features.
        log_level: "debug"
        working_directory: "${{ inputs.working_directory }}"
        reshim: true
